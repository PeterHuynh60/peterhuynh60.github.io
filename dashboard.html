<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Betting Dashboard - Peter Huynh</title>
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico" />
    <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css" />
    <link href="css/styles.css" rel="stylesheet" />
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        body {
            padding-top: 56px;
            font-family: "Muli", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #212529;
            background-color: #77CE93;
        }
        
        .container-fluid {
            padding: 2rem 1.5rem;
            max-width: 2000px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            background-color: #55c278;
            color: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .dashboard-header h1 {
            font-family: "Saira Extra Condensed", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
            font-size: 2rem;
        }
        
        .dashboard-header p {
            margin-bottom: 0;
            opacity: 0.9;
        }
        
        /* Compact Stats Row */
        .stats-row {
            background: white;
            border: 1px solid #dee2e6;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
        }
        
        .stat-item {
            text-align: center;
            padding: 0.5rem;
        }
        
        .stat-item h6 {
            font-family: "Muli", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .stat-item h2 {
            font-family: "Saira Extra Condensed", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-weight: 700;
            font-size: 1.75rem;
            margin-bottom: 0;
            color: #55c278;
        }
        
        .card {
            margin-bottom: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: white;
        }
        
        .card-body {
            padding: 1.25rem;
            text-align: center;
        }
        
        .card-title {
            font-family: "Saira Extra Condensed", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            color: #55c278;
            font-size: 1rem;
        }
        
        .bet-table, .form-section {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            text-align: center;
        }
        
        .bet-table h4, .form-section h4 {
            font-family: "Saira Extra Condensed", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            color: #55c278;
            margin-bottom: 1.25rem;
            font-size: 1.25rem;
            text-align: center;
        }
        
        .table {
            font-family: "Muli", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 0.9rem;
            color: #212529;
            text-align: center;
        }
        
        .table thead th {
            border-top: none;
            border-bottom: 2px solid #dee2e6;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05rem;
            color: #212529;
            background-color: #fff;
            text-align: center;
        }
        
        .table tbody td {
            text-align: center;
            vertical-align: middle;
        }
        
        .badge-bonus {
            background-color: #ffc107;
            color: #000;
        }
        
        .badge-boost {
            background-color: #17a2b8;
            color: #fff;
        }
        
        .badge-won {
            background-color: #28a745;
            color: #fff;
        }
        
        .badge-lost {
            background-color: #dc3545;
            color: #fff;
        }
        
        .badge-push {
            background-color: #6c757d;
            color: #fff;
        }
        
        .badge-pending {
            background-color: #ffc107;
            color: #000;
        }
        
        .badge-secondary {
            background-color: #6c757d;
            color: #fff;
        }
        
        .profit-positive {
            color: #28a745;
            font-weight: bold;
        }
        
        .profit-negative {
            color: #dc3545;
            font-weight: bold;
        }
        
        .back-link {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background-color: #55c278;
            border: none;
            font-family: "Muli", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-weight: 400;
            text-transform: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            color: white;
            text-decoration: none;
            display: inline-block;
        }
        
        .auth-button {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: #55c278;
            border: none;
            font-family: "Muli", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-weight: 400;
            text-transform: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }
        
        .auth-button:hover {
            background-color: #48a869;
        }
        
                .user-info {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: none;
        }
        
        .user-info img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid #55c278;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .user-info img:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(85, 194, 120, 0.5);
        }
        
        .user-dropdown {
            position: absolute;
            top: 55px;
            right: 0;
            background-color: white;
            border: 2px solid #55c278;
            border-radius: 4px;
            padding: 0.5rem;
            display: none;
            min-width: 150px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .user-dropdown.show {
            display: block;
        }
        
        .user-dropdown-name {
            padding: 0.5rem;
            font-size: 0.9rem;
            color: #212529;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .user-dropdown button {
            width: 100%;
            background-color: #dc3545;
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        
        .user-dropdown button:hover {
            background-color: #c82333;
        }
        
        .back-link:hover {
            background-color: #48a869;
            color: white;
            text-decoration: none;
        }
        
        .btn-primary {
            background-color: #55c278;
            border-color: #55c278;
            font-family: "Muli", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-weight: 400;
            text-transform: none;
        }
        
        .btn-primary:hover {
            background-color: #48a869;
            border-color: #48a869;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            font-family: "Muli", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-weight: 400;
            text-transform: none;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            font-family: "Muli", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-weight: 400;
        }
        
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
            font-family: "Muli", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-weight: 400;
        }
        
        label {
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
            display: block;
            text-align: center;
        }
        
        .form-control {
            border: 1px solid #ced4da;
            font-size: 0.9rem;
            text-align: center;
            font-family: "Muli", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            padding: 0.75rem 0.75rem;
            height: auto;
        }
        
        .form-control::placeholder {
            font-family: "Muli", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #6c757d;
            opacity: 0.6;
        }
        
        .form-check-input {
            margin-top: 0;
            position: relative;
            margin-right: 0.5rem;
            border: 2px solid #ced4da;
        }
        
        .form-check-input:checked {
            background-color: #55c278;
            border-color: #55c278;
        }
        
        .form-check-input:focus {
            border-color: #55c278;
            box-shadow: 0 0 0 0.2rem rgba(85, 194, 120, 0.25);
        }
        
        .form-check-label {
            margin-bottom: 0;
            padding-top: 0;
        }
        
        .form-control:focus {
            border-color: #55c278;
            box-shadow: 0 0 0 0.2rem rgba(85, 194, 120, 0.25);
        }
        
        .mb-3 {
            margin-bottom: 1.5rem !important;
        }
        
        .form-control:focus {
            border-color: #55c278;
            box-shadow: 0 0 0 0.2rem rgba(85, 194, 120, 0.25);
        }
        
        .row.mb-4 {
            margin-bottom: 1.5rem !important;
        }
    </style>
</head>
<body>
    <a href="index.html" class="btn btn-dark back-link">Main</a>
    
    <!-- Authentication UI -->
    <button id="sign-in-btn" class="auth-button">Sign In</button>
    <div id="user-info" class="user-info">
        <img id="user-photo" src="" alt="User" onclick="toggleUserDropdown()">
        <div id="user-dropdown" class="user-dropdown">
            <div class="user-dropdown-name" id="user-name"></div>
            <button id="sign-out-btn">Sign Out</button>
        </div>
    </div>
    
    <div class="container-fluid">
        <div class="dashboard-header">
            <h1 class="mb-2">Betting Dashboard</h1>
            <p class="mb-0">Track your sharp betting performance and earnings</p>
        </div>
        
        <!-- Statistics Cards -->
        <div class="stats-row">
            <div class="row">
                <div class="col-lg-2 col-md-4 col-6">
                    <div class="stat-item earnings">
                        <h6>Total Earnings</h6>
                        <h2 id="total-earnings">$0.00</h2>
                    </div>
                </div>
                
                <div class="col-lg-2 col-md-4 col-6">
                    <div class="stat-item bets">
                        <h6>Total Bets</h6>
                        <h2 id="total-bets">0</h2>
                    </div>
                </div>
                
                <div class="col-lg-2 col-md-4 col-6">
                    <div class="stat-item winrate">
                        <h6>Win Rate</h6>
                        <h2 id="win-rate">0%</h2>
                    </div>
                </div>
                
                <div class="col-lg-2 col-md-4 col-6">
                    <div class="stat-item avgwager">
                        <h6>Avg Wager</h6>
                        <h2 id="avg-wager">$0.00</h2>
                    </div>
                </div>
                
                <div class="col-lg-2 col-md-4 col-6">
                    <div class="stat-item avgpayout">
                        <h6>Avg Payout</h6>
                        <h2 id="avg-payout">$0.00</h2>
                    </div>
                </div>
                
                <div class="col-lg-2 col-md-4 col-6">
                    <div class="stat-item avgprofit">
                        <h6>Avg Profit</h6>
                        <h2 id="avg-profit">$0.00</h2>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <!-- Current Balances and Small Profit Chart -->
        <div class="row mb-4">
            <div class="col-lg-8 mb-4">
                <div class="card border-0">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Current Balances by Sportsbook</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Sportsbook</th>
                                        <th>Total Deposited</th>
                                        <th>Total Withdrawn</th>
                                        <th>Current Balance</th>
                                        <th>Total Profit</th>
                                    </tr>
                                </thead>
                                <tbody id="bankroll-balances">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No balances yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <div class="card border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0" style="font-size: 1rem;">Cumulative Profit</h5>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary active" data-timeframe="all" onclick="filterProfitChart('all')" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">All</button>
                                <button type="button" class="btn btn-outline-secondary" data-timeframe="ytd" onclick="filterProfitChart('ytd')" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">YTD</button>
                                <button type="button" class="btn btn-outline-secondary" data-timeframe="12m" onclick="filterProfitChart('12m')" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">12M</button>
                                <button type="button" class="btn btn-outline-secondary" data-timeframe="6m" onclick="filterProfitChart('6m')" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">6M</button>
                                <button type="button" class="btn btn-outline-secondary" data-timeframe="3m" onclick="filterProfitChart('3m')" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">3M</button>
                            </div>
                        </div>
                        <canvas id="profit-chart" style="max-height: 200px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sportsbook Profit and Strategy Charts -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card border-0">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Profit by Strategy</h5>
                        <canvas id="strategy-chart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card border-0">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Profit by Sportsbook</h5>
                        <canvas id="sportsbook-profit-chart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pending Bets Section -->
        <div class="bet-table mb-4">
            <h4 class="mb-4">Pending Bets</h4>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Sportsbook</th>
                            <th>Sport/Event</th>
                            <th>Type</th>
                            <th>Wager</th>
                            <th>Odds</th>
                            <th>Expected Payout</th>
                            <th>Flags</th>
                            <th>Resolve</th>
                        </tr>
                    </thead>
                    <tbody id="pending-bets">
                        <tr>
                            <td colspan="9" class="text-center text-muted">No pending bets</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Bet History Table -->
        <div class="bet-table">
            <h4 class="mb-4">Bet History</h4>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Sportsbook</th>
                            <th>Sport/Event</th>
                            <th>Type</th>
                            <th>Wager</th>
                            <th>Odds</th>
                            <th>Payout</th>
                            <th>Profit</th>
                            <th>Result</th>
                            <th>Flags</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bet-history">
                        <tr>
                            <td colspan="11" class="text-center text-muted">No completed bets yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Transaction History Table (Last 10) -->
        <div class="bet-table">
            <h4 class="mb-4">Transaction History</h4>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Sportsbook</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th class="admin-only">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bankroll-transactions">
                        <tr>
                            <td colspan="5" class="text-center text-muted">No transactions yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
        
        <!-- Add New Bet Form -->
        <div class="form-section mb-5" id="add-bet-section" style="display: none;">
            <h4 class="mb-4">Add New Bet</h4>
            
            <!-- Form -->
            <form id="bet-form">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="bet-date">Date</label>
                        <input type="date" class="form-control" id="bet-date" required>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="bet-sportsbook">Sportsbook</label>
                        <input type="text" class="form-control" id="bet-sportsbook" placeholder="e.g., DraftKings" required>
                    </div>
                    
                    <div class="col-md-6 mb-3" id="single-sport-container">
                        <label for="bet-sport">Sport/Event</label>
                        <input type="text" class="form-control" id="bet-sport" placeholder="e.g., NFL - Chiefs vs Bills">
                    </div>
                    
                    <div class="col-md-6 mb-3" id="parlay-legs-container" style="display: none;">
                        <label>Parlay Legs</label>
                        <div id="parlay-legs">
                            <div class="parlay-leg mb-2">
                                <input type="text" class="form-control parlay-leg-input" placeholder="Sport/Event (e.g., NBA: Lakers ML)">
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary mt-2" id="add-parlay-leg">Add Leg</button>
                        <button type="button" class="btn btn-sm btn-danger mt-2 ml-2" id="remove-parlay-leg" style="display: none;">- Remove Leg</button>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="bet-type">Bet Type</label>
                        <select class="form-control" id="bet-type" required>
                            <option value="">Select type...</option>
                            <option value="Straight">Straight</option>
                            <option value="Parlay">Parlay</option>
                            <option value="Promotion Harvesting">Promotion Harvesting</option>
                            <option value="+EV Betting">+EV Betting</option>
                            <option value="Arbitrage">Arbitrage</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="bet-wager" id="bet-wager-label">Wager ($)</label>
                        <input type="number" step="0.01" class="form-control" id="bet-wager" placeholder="100.00" required>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="bet-odds">Odds (American)</label>
                        <input type="text" class="form-control" id="bet-odds" placeholder="-110 or +150" required>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="bet-payout">Payout ($)</label>
                        <input type="number" step="0.01" class="form-control" id="bet-payout" placeholder="191.00" required>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="bet-result">Result</label>
                        <select class="form-control" id="bet-result" required>
                            <option value="">Select result...</option>
                            <option value="Won">Won</option>
                            <option value="Lost">Lost</option>
                            <option value="Push">Push</option>
                            <option value="Pending">Pending</option>
                        </select>
                    </div>
                    
                    <div class="col-md-12 mb-3">
                        <label>Flags</label>
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="form-check d-flex align-items-center mr-4">
                                <input class="form-check-input" type="checkbox" id="bet-bonus" style="margin-right: 0.5rem;">
                                <label class="form-check-label" for="bet-bonus" style="text-transform: none; font-weight: 400; color: #212529; font-size: 0.9rem; margin-bottom: 0;">Bonus Bet</label>
                            </div>
                            <div class="form-check d-flex align-items-center">
                                <input class="form-check-input" type="checkbox" id="bet-boost" style="margin-right: 0.5rem;">
                                <label class="form-check-label" for="bet-boost" style="text-transform: none; font-weight: 400; color: #212529; font-size: 0.9rem; margin-bottom: 0;">Profit Boost</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-12 mb-3">
                        <label for="bet-notes">Notes (Optional)</label>
                        <textarea class="form-control" id="bet-notes" rows="2" placeholder="Any additional notes..."></textarea>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">Add Bet</button>
                </div>
            </form>
        </div>
        
        
        <!-- Add New Transaction Form -->
        <div class="form-section mb-5" id="bankroll-section" style="display: none;">
            <h4 class="mb-4">Add New Transaction</h4>
            
            <form id="bankroll-form" class="mb-4">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="bankroll-date">Date</label>
                        <input type="date" class="form-control" id="bankroll-date" required>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="bankroll-sportsbook">Sportsbook</label>
                        <input type="text" class="form-control" id="bankroll-sportsbook" placeholder="e.g., DraftKings" required>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="bankroll-type">Transaction Type</label>
                        <select class="form-control" id="bankroll-type" required>
                            <option value="">Select type...</option>
                            <option value="Deposit">Deposit</option>
                            <option value="Withdraw">Withdraw</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="bankroll-amount">Amount ($)</label>
                        <input type="number" step="0.01" class="form-control" id="bankroll-amount" placeholder="100.00" required>
                    </div>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="btn btn-primary">Add Transaction</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Bet Modal -->
    <div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto;">
        <div style="background: white; max-width: 800px; margin: 50px auto; padding: 2rem; border-radius: 8px; position: relative;">
            <button onclick="closeEditModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            
            <h4 style="font-family: 'Saira Extra Condensed', sans-serif; font-weight: 700; text-transform: uppercase; color: #55c278; margin-bottom: 1.5rem; text-align: center;">Edit Bet</h4>
            
            <form id="edit-bet-form">
                <input type="hidden" id="edit-bet-id">
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="edit-bet-date">Date</label>
                        <input type="date" class="form-control" id="edit-bet-date" required>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="edit-bet-sportsbook">Sportsbook</label>
                        <input type="text" class="form-control" id="edit-bet-sportsbook" required>
                    </div>
                    
                    <div class="col-md-6 mb-3" id="edit-single-sport-container">
                        <label for="edit-bet-sport">Sport/Event</label>
                        <input type="text" class="form-control" id="edit-bet-sport">
                    </div>
                    
                    <div class="col-md-6 mb-3" id="edit-parlay-legs-container" style="display: none;">
                        <label>Parlay Legs</label>
                        <div id="edit-parlay-legs"></div>
                        <button type="button" class="btn btn-sm btn-primary mt-2" id="edit-add-parlay-leg">Add Leg</button>
                        <button type="button" class="btn btn-sm btn-danger mt-2 ml-2" id="edit-remove-parlay-leg" style="display: none;">- Remove Leg</button>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="edit-bet-type">Bet Type</label>
                        <select class="form-control" id="edit-bet-type" required>
                            <option value="">Select type...</option>
                            <option value="Straight">Straight</option>
                            <option value="Parlay">Parlay</option>
                            <option value="Promotion Harvesting">Promotion Harvesting</option>
                            <option value="+EV Betting">+EV Betting</option>
                            <option value="Arbitrage">Arbitrage</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="edit-bet-wager" id="edit-bet-wager-label">Wager ($)</label>
                        <input type="number" step="0.01" class="form-control" id="edit-bet-wager" required>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="edit-bet-odds">Odds (American)</label>
                        <input type="text" class="form-control" id="edit-bet-odds" required>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="edit-bet-payout">Payout ($)</label>
                        <input type="number" step="0.01" class="form-control" id="edit-bet-payout" required>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="edit-bet-result">Result</label>
                        <select class="form-control" id="edit-bet-result" required>
                            <option value="">Select result...</option>
                            <option value="Won">Won</option>
                            <option value="Lost">Lost</option>
                            <option value="Push">Push</option>
                            <option value="Pending">Pending</option>
                        </select>
                    </div>
                    
                    <div class="col-md-12 mb-3">
                        <label>Flags</label>
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="form-check d-flex align-items-center mr-4">
                                <input class="form-check-input" type="checkbox" id="edit-bet-bonus" style="margin-right: 0.5rem;">
                                <label class="form-check-label" for="edit-bet-bonus" style="text-transform: none; font-weight: 400; color: #212529; font-size: 0.9rem; margin-bottom: 0;">Bonus Bet</label>
                            </div>
                            <div class="form-check d-flex align-items-center">
                                <input class="form-check-input" type="checkbox" id="edit-bet-boost" style="margin-right: 0.5rem;">
                                <label class="form-check-label" for="edit-bet-boost" style="text-transform: none; font-weight: 400; color: #212529; font-size: 0.9rem; margin-bottom: 0;">Profit Boost</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-12 mb-3">
                        <label for="edit-bet-notes">Notes (Optional)</label>
                        <textarea class="form-control" id="edit-bet-notes" rows="2"></textarea>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">Save Changes</button>
                    <button type="button" class="btn btn-danger btn-lg ml-2" onclick="deleteFromEdit()">Delete Bet</button>
                    <button type="button" class="btn btn-secondary btn-lg ml-2" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
          apiKey: "AIzaSyBLj4AYOc39hIaFAPKQrumsifP7bbyJ5To",
          authDomain: "betting-dashboard-c224e.firebaseapp.com",
          projectId: "betting-dashboard-c224e",
          storageBucket: "betting-dashboard-c224e.firebasestorage.app",
          messagingSenderId: "416492918120",
          appId: "1:416492918120:web:e52afea521a508a89cf2dd"
        };
        
        // TODO: Replace with YOUR email address (the one you'll sign in with)
        const AUTHORIZED_EMAIL = "peter@huynh.place";
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Track authentication state
        let currentUser = null;
        let isAdmin = false;
        
        // ============================================
        // AUTHENTICATION
        // ============================================
        
        // Listen for auth state changes
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            
            if (user) {
                // User is signed in
                isAdmin = user.email === AUTHORIZED_EMAIL;
                
                // Update UI
                document.getElementById('sign-in-btn').style.display = 'none';
                document.getElementById('user-info').style.display = 'flex';
                document.getElementById('user-photo').src = user.photoURL || 'https://via.placeholder.com/30';
                document.getElementById('user-name').textContent = user.displayName || user.email;
                
                // Show/hide admin features
                if (isAdmin) {
                    document.getElementById('add-bet-section').style.display = 'block';
                    document.getElementById('bankroll-section').style.display = 'block';
                    // Show delete buttons
                    document.querySelectorAll('.admin-only').forEach(el => {
                        el.style.display = '';
                    });
                } else {
                    document.getElementById('add-bet-section').style.display = 'none';
                    document.getElementById('bankroll-section').style.display = 'none';
                    document.querySelectorAll('.admin-only').forEach(el => {
                        el.style.display = 'none';
                    });
                }
            } else {
                // User is signed out
                isAdmin = false;
                
                // Update UI
                document.getElementById('sign-in-btn').style.display = 'block';
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('add-bet-section').style.display = 'none';
                document.getElementById('bankroll-section').style.display = 'none';
                
                // Hide admin features
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'none';
                });
            }
            
            // Reload dashboard to reflect changes
            loadDashboard();
        });
        
        // Sign in with Google
        document.getElementById('sign-in-btn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch((error) => {
                console.error('Sign-in error:', error);
                alert('Sign-in failed: ' + error.message);
            });
        });
        
        // Sign out
        document.getElementById('sign-out-btn').addEventListener('click', () => {
            auth.signOut().catch((error) => {
                console.error('Sign-out error:', error);
                alert('Sign-out failed: ' + error.message);
            });
        });
        
        // Toggle user dropdown menu
        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('show');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            const userInfo = document.getElementById('user-info');
            const dropdown = document.getElementById('user-dropdown');
            
            // If click is outside user-info area and dropdown is open
            if (!userInfo.contains(event.target) && dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            }
        });
        
        // ============================================
        // STORAGE WRAPPER (Firebase Firestore)
        // ============================================
        const storage = {
            async get(key) {
                try {
                    const doc = await db.collection('bets').doc(key).get();
                    if (doc.exists) {
                        return { key: key, value: doc.data().value };
                    }
                    return null;
                } catch (error) {
                    console.error('Error getting document:', error);
                    throw error;
                }
            },
            
            async set(key, value) {
                try {
                    await db.collection('bets').doc(key).set({ value: value });
                    return { key: key, value: value };
                } catch (error) {
                    console.error('Error setting document:', error);
                    throw error;
                }
            },
            
            async delete(key) {
                try {
                    await db.collection('bets').doc(key).delete();
                    return { key: key, deleted: true };
                } catch (error) {
                    console.error('Error deleting document:', error);
                    throw error;
                }
            },
            
            async list(prefix) {
                try {
                    const snapshot = await db.collection('bets').get();
                    const keys = [];
                    snapshot.forEach(doc => {
                        if (!prefix || doc.id.startsWith(prefix)) {
                            keys.push(doc.id);
                        }
                    });
                    return { keys: keys };
                } catch (error) {
                    console.error('Error listing documents:', error);
                    throw error;
                }
            }
        };
        
        // ============================================
        // DASHBOARD CODE
        // ============================================
        let profitChart, strategyChart, sportsbookProfitChart;
        let allBets = []; // Store all bets globally for filtering
        let currentTimeframe = 'all'; // Current time filter
        
        // Helper function to get local date string in YYYY-MM-DD format
        function getLocalDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Helper function to format date for display (avoids timezone shift)
        function formatDateForDisplay(dateString) {
            // Parse as local date (YYYY-MM-DD format)
            const [year, month, day] = dateString.split('-');
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // Set today's date as default (using local timezone)
        document.getElementById('bet-date').value = getLocalDateString();
        document.getElementById('bankroll-date').value = getLocalDateString();
        
        // Load dashboard data
        async function loadDashboard() {
            try {
                const result = await storage.list('bet:');
                
                if (!result || !result.keys || result.keys.length === 0) {
                    console.log('No betting data found');
                    return;
                }
                
                const bets = [];
                for (const key of result.keys) {
                    try {
                        const betResult = await storage.get(key);
                        if (betResult && betResult.value) {
                            const bet = JSON.parse(betResult.value);
                            bet.id = key;
                            bets.push(bet);
                        }
                    } catch (err) {
                        console.error('Error fetching bet:', err);
                    }
                }
                
                if (bets.length === 0) return;
                
                // Sort by date (newest first)
                bets.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Store globally for filtering
                allBets = bets;
                
                updateStatistics(bets);
                updateCharts(bets);
                updatePendingTable(bets);
                updateTable(bets);
                loadBankroll();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error loading dashboard data');
            }
        }
        
        function updateStatistics(bets) {
            // Only count completed bets for statistics
            const completedBets = bets.filter(bet => bet.result !== 'Pending');
            
            // Calculate total earnings (excluding bonus bet wagers from profit calculation)
            const totalEarnings = completedBets.reduce((sum, bet) => {
                if (bet.bonusBet) {
                    // For bonus bets, profit = payout (since wager was $0 of real money)
                    return sum + bet.payout;
                } else {
                    return sum + bet.profit;
                }
            }, 0);
            
            const totalBets = completedBets.length;
            // Calculate win rate (exclude non-parlay promotion harvesting losses)
            const betsForWinRate = completedBets.filter(bet => {
                // Exclude if: non-parlay AND promotion harvesting AND lost
                const isNonParlayPromoLoss = bet.betType === 'Promotion Harvesting' 
                    && bet.betType !== 'Parlay' 
                    && bet.result === 'Lost';
                return !isNonParlayPromoLoss;
            });
            const winningBets = betsForWinRate.filter(bet => bet.result === 'Won').length;
            const winRate = betsForWinRate.length > 0 ? ((winningBets / betsForWinRate.length) * 100).toFixed(1) : 0;
            
            // Calculate averages
            // Exclude bonus bet wagers from avg wager calculation
            const nonBonusBets = completedBets.filter(bet => !bet.bonusBet);
            const totalWager = nonBonusBets.reduce((sum, bet) => sum + bet.wager, 0);
            const avgWager = nonBonusBets.length > 0 ? (totalWager / nonBonusBets.length) : 0;
            
            // Include all payouts in avg payout
            const totalPayout = completedBets.reduce((sum, bet) => sum + bet.payout, 0);
            const avgPayout = totalBets > 0 ? (totalPayout / totalBets) : 0;
            
            // Avg profit uses totalEarnings which already accounts for bonus bets
            const avgProfit = totalBets > 0 ? (totalEarnings / totalBets) : 0;
            
            // Format currency with proper negative sign placement
            const formatCurrency = (amount) => amount >= 0 ? '$' + amount.toFixed(2) : '-$' + Math.abs(amount).toFixed(2);
            
            document.getElementById('total-earnings').textContent = formatCurrency(totalEarnings);
            document.getElementById('total-bets').textContent = totalBets;
            document.getElementById('win-rate').textContent = winRate + '%';
            document.getElementById('avg-wager').textContent = formatCurrency(avgWager);
            document.getElementById('avg-payout').textContent = formatCurrency(avgPayout);
            document.getElementById('avg-profit').textContent = formatCurrency(avgProfit);
        }
        
        function updatePendingTable(bets) {
            const pendingBets = bets.filter(bet => bet.result === 'Pending');
            const tbody = document.getElementById('pending-bets');
            
            if (pendingBets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No pending bets</td></tr>';
                return;
            }
            
            tbody.innerHTML = pendingBets.map(bet => {
                // Format sport/event - handle both string and array (parlay)
                let sportDisplay;
                if (Array.isArray(bet.sport)) {
                    sportDisplay = bet.sport.map((leg, i) => `${i + 1}. ${leg}`).join('<br>');
                } else {
                    sportDisplay = bet.sport;
                }
                
                return `
                <tr>
                    <td>${formatDateForDisplay(bet.date)}</td>
                    <td>${bet.sportsbook}</td>
                    <td style="text-align: center;">${sportDisplay}</td>
                    <td><span class="badge badge-secondary">${bet.betType}</span></td>
                    <td>$${bet.wager.toFixed(2)}</td>
                    <td>${bet.odds}</td>
                    <td>$${bet.payout.toFixed(2)}</td>
                    <td>
                        ${bet.bonusBet ? '<span class="badge badge-bonus">Bonus</span> ' : ''}
                        ${bet.profitBoost ? '<span class="badge badge-boost">Boost</span>' : ''}
                    </td>
                    <td class="admin-only">
                        <button class="btn btn-sm btn-success" onclick="resolveBet('${bet.id}', 'Won')">Won</button>
                        <button class="btn btn-sm btn-danger" onclick="resolveBet('${bet.id}', 'Lost')">Lost</button>
                        <button class="btn btn-sm btn-secondary" onclick="resolveBet('${bet.id}', 'Push')">Push</button>
                        <br>
                        <button class="btn btn-sm btn-primary mt-2" onclick="openEditModal('${bet.id}')">Edit</button>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        function updateCharts(bets) {
            // Only chart completed bets
            const completedBets = bets.filter(bet => bet.result !== 'Pending');
            const sortedBets = [...completedBets].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Cumulative profit chart (accounting for bonus bets)
            // Start at (0,0)
            let cumulativeProfit = 0;
            const profitData = [{ date: null, profit: 0 }]; // Add starting point at 0
            
            sortedBets.forEach(bet => {
                if (bet.bonusBet) {
                    // For bonus bets, profit = payout (wager was $0 real money)
                    cumulativeProfit += bet.payout;
                } else {
                    cumulativeProfit += bet.profit;
                }
                profitData.push({
                    date: bet.date,
                    profit: cumulativeProfit
                });
            });
            
            const profitCtx = document.getElementById('profit-chart').getContext('2d');
            
            if (profitChart) profitChart.destroy();
            
            profitChart = new Chart(profitCtx, {
                type: 'line',
                data: {
                    labels: profitData.map((d, i) => i === 0 ? 'Start' : new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Cumulative Profit',
                        data: profitData.map(d => d.profit),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: false  // Hide x-axis labels
                        },
                        y: {
                            ticks: {
                                callback: value => '$' + value.toFixed(0)
                            }
                        }
                    }
                }
            });
            
            // Strategy breakdown chart (accounting for bonus bets)
            const strategyTotals = {};
            completedBets.forEach(bet => {
                if (!strategyTotals[bet.betType]) {
                    strategyTotals[bet.betType] = 0;
                }
                if (bet.bonusBet) {
                    // For bonus bets, profit = payout
                    strategyTotals[bet.betType] += bet.payout;
                } else {
                    strategyTotals[bet.betType] += bet.profit;
                }
            });
            
            const strategyCtx = document.getElementById('strategy-chart').getContext('2d');
            
            if (strategyChart) strategyChart.destroy();
            
            strategyChart = new Chart(strategyCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(strategyTotals),
                    datasets: [{
                        data: Object.values(strategyTotals),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#4facfe',
                            '#43e97b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // Sportsbook profit breakdown chart
            const sportsbookTotals = {};
            completedBets.forEach(bet => {
                const sportsbook = bet.sportsbook || 'Unknown';
                if (!sportsbookTotals[sportsbook]) {
                    sportsbookTotals[sportsbook] = 0;
                }
                if (bet.bonusBet) {
                    sportsbookTotals[sportsbook] += bet.payout;
                } else {
                    sportsbookTotals[sportsbook] += bet.profit;
                }
            });
            
            const sportsbookProfitCtx = document.getElementById('sportsbook-profit-chart').getContext('2d');
            
            if (sportsbookProfitChart) sportsbookProfitChart.destroy();
            
            sportsbookProfitChart = new Chart(sportsbookProfitCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(sportsbookTotals),
                    datasets: [{
                        data: Object.values(sportsbookTotals),
                        backgroundColor: [
                            '#28a745',
                            '#007bff',
                            '#ffc107',
                            '#dc3545',
                            '#6f42c1',
                            '#fd7e14',
                            '#20c997',
                            '#e83e8c',
                            '#17a2b8',
                            '#6c757d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: $${context.parsed.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateTable(bets) {
            // Only show completed bets (last 10)
            const completedBets = bets.filter(bet => bet.result !== 'Pending');
            const last10Bets = completedBets.slice(0, 10); // Show only last 10
            const tbody = document.getElementById('bet-history');
            
            if (last10Bets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">No completed bets yet.</td></tr>';
                return;
            }
            
            tbody.innerHTML = completedBets.map(bet => {
                // Format sport/event - handle both string and array (parlay)
                let sportDisplay;
                if (Array.isArray(bet.sport)) {
                    sportDisplay = bet.sport.map((leg, i) => `${i + 1}. ${leg}`).join('<br>');
                } else {
                    sportDisplay = bet.sport;
                }
                
                // Calculate displayed profit (for bonus bets, show payout as profit)
                const displayedProfit = bet.bonusBet ? bet.payout : bet.profit;
                
                // Show expected payout if available (for lost bets), otherwise show actual payout
                const displayedPayout = bet.expectedPayout || bet.payout;
                
                return `
                <tr>
                    <td>${formatDateForDisplay(bet.date)}</td>
                    <td>${bet.sportsbook}</td>
                    <td style="text-align: center;">${sportDisplay}</td>
                    <td><span class="badge badge-secondary">${bet.betType}</span></td>
                    <td>$${bet.wager.toFixed(2)}</td>
                    <td>${bet.odds}</td>
                    <td>$${displayedPayout.toFixed(2)}</td>
                    <td class="${displayedProfit >= 0 ? 'profit-positive' : 'profit-negative'}">
                        ${displayedProfit >= 0 ? '+$' + displayedProfit.toFixed(2) : '-$' + Math.abs(displayedProfit).toFixed(2)}
                    </td>
                    <td><span class="badge badge-${bet.result.toLowerCase()}">${bet.result}</span></td>
                    <td>
                        ${bet.bonusBet ? '<span class="badge badge-bonus">Bonus</span> ' : ''}
                        ${bet.profitBoost ? '<span class="badge badge-boost">Boost</span>' : ''}
                    </td>
                    <td class="admin-only">
                        <button class="btn btn-sm btn-primary" onclick="openEditModal('${bet.id}')">Edit</button>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        // Add new bet
        document.getElementById('bet-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const wager = parseFloat(document.getElementById('bet-wager').value);
            const payout = parseFloat(document.getElementById('bet-payout').value);
            const profit = payout - wager;
            const betType = document.getElementById('bet-type').value;
            
            // Collect sport/event info based on bet type
            let sportInfo;
            if (betType === 'Parlay') {
                const parlayInputs = document.querySelectorAll('.parlay-leg-input');
                sportInfo = Array.from(parlayInputs)
                    .map(input => input.value.trim())
                    .filter(val => val !== '');
                
                if (sportInfo.length === 0) {
                    alert('Please add at least one parlay leg');
                    return;
                }
            } else {
                sportInfo = document.getElementById('bet-sport').value;
                if (!sportInfo) {
                    alert('Please enter a sport/event');
                    return;
                }
            }
            
            const bet = {
                date: document.getElementById('bet-date').value,
                sportsbook: document.getElementById('bet-sportsbook').value,
                sport: sportInfo, // Will be string for single bets, array for parlays
                betType: betType,
                wager: wager,
                odds: document.getElementById('bet-odds').value,
                payout: payout,
                profit: profit,
                result: document.getElementById('bet-result').value,
                bonusBet: document.getElementById('bet-bonus').checked,
                profitBoost: document.getElementById('bet-boost').checked,
                notes: document.getElementById('bet-notes').value
            };
            
            try {
                const timestamp = Date.now();
                await storage.set(`bet:${timestamp}`, JSON.stringify(bet));
                
                // Deduct wager from bankroll (add withdrawal transaction) - only if not a bonus bet
                if (!bet.bonusBet) {
                    try {
                        await db.collection('bankroll').add({
                            date: bet.date,
                            sportsbook: bet.sportsbook,
                            type: 'Withdraw',
                            amount: bet.wager,
                            timestamp: timestamp,
                            note: 'Bet placed'
                        });
                    } catch (bankrollError) {
                        console.error('Error updating bankroll:', bankrollError);
                        // Don't fail the bet if bankroll update fails
                    }
                }
                
                alert('Bet added successfully!');
                document.getElementById('bet-form').reset();
                document.getElementById('bet-date').value = getLocalDateString();
                
                // Reset parlay legs to single default leg
                const parlayLegsDiv = document.getElementById('parlay-legs');
                parlayLegsDiv.innerHTML = '<div class="parlay-leg mb-2"><input type="text" class="form-control parlay-leg-input" placeholder="Sport/Event (e.g., NBA: Lakers ML)"></div>';
                document.getElementById('remove-parlay-leg').style.display = 'none';
                
                loadDashboard();
            } catch (error) {
                console.error('Error saving bet:', error);
                alert('Error saving bet: ' + error.message);
            }
        });
        
        // Resolve pending bet
        async function resolveBet(betId, result) {
            try {
                const betResult = await storage.get(betId);
                if (!betResult || !betResult.value) {
                    alert('Bet not found');
                    return;
                }
                
                const bet = JSON.parse(betResult.value);
                
                // Store expected payout before modifying (if not already stored)
                if (!bet.expectedPayout) {
                    bet.expectedPayout = bet.payout;
                }
                
                bet.result = result;
                
                // Update profit based on result
                if (result === 'Lost') {
                    bet.payout = 0;  // Actual payout is $0 for calculations
                    bet.profit = -bet.wager;
                } else if (result === 'Push') {
                    bet.payout = bet.wager;
                    bet.profit = 0;
                }
                // For 'Won', keep the original payout and profit
                
                await storage.set(betId, JSON.stringify(bet));
                
                alert(`Bet marked as ${result}!`);
                loadDashboard();
            } catch (error) {
                console.error('Error resolving bet:', error);
                alert('Error resolving bet');
            }
        }
        
        // Delete bet
        async function deleteBet(betId) {
            if (!confirm('Are you sure you want to delete this bet?')) return;
            
            try {
                await storage.delete(betId);
                alert('Bet deleted successfully!');
                loadDashboard();
            } catch (error) {
                console.error('Error deleting bet:', error);
                alert('Error deleting bet');
            }
        }
        
        // Open edit modal
        async function openEditModal(betId) {
            try {
                const betResult = await storage.get(betId);
                if (!betResult || !betResult.value) {
                    alert('Bet not found');
                    return;
                }
                
                const bet = JSON.parse(betResult.value);
                
                // Populate form
                document.getElementById('edit-bet-id').value = betId;
                document.getElementById('edit-bet-date').value = bet.date;
                document.getElementById('edit-bet-sportsbook').value = bet.sportsbook;
                document.getElementById('edit-bet-type').value = bet.betType;
                document.getElementById('edit-bet-wager').value = bet.wager;
                document.getElementById('edit-bet-odds').value = bet.odds;
                // Use expected payout if available (for lost bets), otherwise use actual payout
                document.getElementById('edit-bet-payout').value = bet.expectedPayout || bet.payout;
                document.getElementById('edit-bet-result').value = bet.result;
                document.getElementById('edit-bet-bonus').checked = bet.bonusBet;
                document.getElementById('edit-bet-boost').checked = bet.profitBoost;
                document.getElementById('edit-bet-notes').value = bet.notes || '';
                
                // Set wager label based on bonus bet status
                const wagerLabel = document.getElementById('edit-bet-wager-label');
                if (bet.bonusBet) {
                    wagerLabel.textContent = 'Bonus Bet Wager ($)';
                } else {
                    wagerLabel.textContent = 'Wager ($)';
                }
                
                // Handle sport/parlay legs
                if (bet.betType === 'Parlay' && Array.isArray(bet.sport)) {
                    document.getElementById('edit-single-sport-container').style.display = 'none';
                    document.getElementById('edit-parlay-legs-container').style.display = 'block';
                    
                    const parlayLegsDiv = document.getElementById('edit-parlay-legs');
                    parlayLegsDiv.innerHTML = bet.sport.map(leg => 
                        `<div class="parlay-leg mb-2"><input type="text" class="form-control parlay-leg-input" value="${leg}"></div>`
                    ).join('');
                    
                    if (bet.sport.length > 1) {
                        document.getElementById('edit-remove-parlay-leg').style.display = 'inline-block';
                    }
                } else {
                    document.getElementById('edit-single-sport-container').style.display = 'block';
                    document.getElementById('edit-parlay-legs-container').style.display = 'none';
                    document.getElementById('edit-bet-sport').value = bet.sport;
                }
                
                // Show modal
                document.getElementById('edit-modal').style.display = 'block';
            } catch (error) {
                console.error('Error loading bet for edit:', error);
                alert('Error loading bet');
            }
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            document.getElementById('edit-bet-form').reset();
        }
        
        // Delete from edit modal
        async function deleteFromEdit() {
            const betId = document.getElementById('edit-bet-id').value;
            closeEditModal();
            await deleteBet(betId);
        }
        
        // Handle edit bet type change
        document.getElementById('edit-bet-type').addEventListener('change', function() {
            const singleContainer = document.getElementById('edit-single-sport-container');
            const parlayContainer = document.getElementById('edit-parlay-legs-container');
            
            if (this.value === 'Parlay') {
                singleContainer.style.display = 'none';
                parlayContainer.style.display = 'block';
            } else {
                singleContainer.style.display = 'block';
                parlayContainer.style.display = 'none';
            }
        });
        
        // Add parlay leg in edit modal
        document.getElementById('edit-add-parlay-leg').addEventListener('click', function() {
            const parlayLegsDiv = document.getElementById('edit-parlay-legs');
            const newLeg = document.createElement('div');
            newLeg.className = 'parlay-leg mb-2';
            newLeg.innerHTML = '<input type="text" class="form-control parlay-leg-input" placeholder="Sport/Event (e.g., NBA: Lakers ML)">';
            parlayLegsDiv.appendChild(newLeg);
            
            const legCount = parlayLegsDiv.querySelectorAll('.parlay-leg').length;
            if (legCount > 1) {
                document.getElementById('edit-remove-parlay-leg').style.display = 'inline-block';
            }
        });
        
        // Remove parlay leg in edit modal
        document.getElementById('edit-remove-parlay-leg').addEventListener('click', function() {
            const parlayLegsDiv = document.getElementById('edit-parlay-legs');
            const legs = parlayLegsDiv.querySelectorAll('.parlay-leg');
            
            if (legs.length > 1) {
                legs[legs.length - 1].remove();
            }
            
            if (legs.length <= 2) {
                this.style.display = 'none';
            }
        });
        
        // Submit edit bet form
        document.getElementById('edit-bet-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const betId = document.getElementById('edit-bet-id').value;
            const wager = parseFloat(document.getElementById('edit-bet-wager').value);
            const payout = parseFloat(document.getElementById('edit-bet-payout').value);
            const profit = payout - wager;
            const betType = document.getElementById('edit-bet-type').value;
            
            // Collect sport/event info based on bet type
            let sportInfo;
            if (betType === 'Parlay') {
                const parlayInputs = document.querySelectorAll('#edit-parlay-legs .parlay-leg-input');
                sportInfo = Array.from(parlayInputs)
                    .map(input => input.value.trim())
                    .filter(val => val !== '');
                
                if (sportInfo.length === 0) {
                    alert('Please add at least one parlay leg');
                    return;
                }
            } else {
                sportInfo = document.getElementById('edit-bet-sport').value;
                if (!sportInfo) {
                    alert('Please enter a sport/event');
                    return;
                }
            }
            
            const result = document.getElementById('edit-bet-result').value;
            
            const bet = {
                date: document.getElementById('edit-bet-date').value,
                sportsbook: document.getElementById('edit-bet-sportsbook').value,
                sport: sportInfo,
                betType: betType,
                wager: wager,
                odds: document.getElementById('edit-bet-odds').value,
                result: result,
                bonusBet: document.getElementById('edit-bet-bonus').checked,
                profitBoost: document.getElementById('edit-bet-boost').checked,
                notes: document.getElementById('edit-bet-notes').value
            };
            
            // Set payout and profit based on result
            if (result === 'Lost') {
                bet.expectedPayout = payout;  // Store what it would have paid
                bet.payout = 0;  // Actual payout is $0
                bet.profit = -wager;
            } else if (result === 'Push') {
                bet.expectedPayout = payout;  // Store expected payout
                bet.payout = wager;  // Get wager back
                bet.profit = 0;
            } else if (result === 'Won') {
                bet.payout = payout;  // Full payout
                bet.profit = profit;
                // expectedPayout not needed for won bets
            } else if (result === 'Pending') {
                bet.payout = payout;  // Expected payout
                bet.profit = profit;  // Expected profit
                // Will be recalculated when resolved
            }
            
            try {
                await storage.set(betId, JSON.stringify(bet));
                alert('Bet updated successfully!');
                closeEditModal();
                loadDashboard();
            } catch (error) {
                console.error('Error updating bet:', error);
                alert('Error updating bet: ' + error.message);
            }
        });
        
        // Load dashboard on page load
        // Add event listeners to highlight filled inputs with green border
        document.querySelectorAll('.form-control').forEach(input => {
            input.addEventListener('input', function() {
                if (this.value.trim() !== '') {
                    this.style.borderColor = '#55c278';
                } else {
                    this.style.borderColor = '#ced4da';
                }
            });
        });
        
        // Handle bet type change to show/hide parlay legs
        document.getElementById('bet-type').addEventListener('change', function() {
            const singleContainer = document.getElementById('single-sport-container');
            const parlayContainer = document.getElementById('parlay-legs-container');
            
            if (this.value === 'Parlay') {
                singleContainer.style.display = 'none';
                parlayContainer.style.display = 'block';
                document.getElementById('bet-sport').removeAttribute('required');
            } else {
                singleContainer.style.display = 'block';
                parlayContainer.style.display = 'none';
                document.getElementById('bet-sport').setAttribute('required', 'required');
            }
        });
        
        // Handle bonus bet checkbox - change wager label
        document.getElementById('bet-bonus').addEventListener('change', function() {
            const wagerLabel = document.getElementById('bet-wager-label');
            if (this.checked) {
                wagerLabel.textContent = 'Bonus Bet Wager ($)';
            } else {
                wagerLabel.textContent = 'Wager ($)';
            }
        });
        
        // Handle bonus bet checkbox in edit modal
        document.getElementById('edit-bet-bonus').addEventListener('change', function() {
            const wagerLabel = document.getElementById('edit-bet-wager-label');
            if (this.checked) {
                wagerLabel.textContent = 'Bonus Bet Wager ($)';
            } else {
                wagerLabel.textContent = 'Wager ($)';
            }
        });
        
        // Add parlay leg
        document.getElementById('add-parlay-leg').addEventListener('click', function() {
            const parlayLegsDiv = document.getElementById('parlay-legs');
            const newLeg = document.createElement('div');
            newLeg.className = 'parlay-leg mb-2';
            newLeg.innerHTML = '<input type="text" class="form-control parlay-leg-input" placeholder="Sport/Event (e.g., NBA: Lakers ML)">';
            parlayLegsDiv.appendChild(newLeg);
            
            // Show remove button if more than 1 leg
            const legCount = parlayLegsDiv.querySelectorAll('.parlay-leg').length;
            if (legCount > 1) {
                document.getElementById('remove-parlay-leg').style.display = 'inline-block';
            }
        });
        
        // Remove parlay leg
        document.getElementById('remove-parlay-leg').addEventListener('click', function() {
            const parlayLegsDiv = document.getElementById('parlay-legs');
            const legs = parlayLegsDiv.querySelectorAll('.parlay-leg');
            
            if (legs.length > 1) {
                legs[legs.length - 1].remove();
            }
            
            // Hide remove button if only 1 leg remains
            if (legs.length <= 2) {
                this.style.display = 'none';
            }
        });
        
        // ============================================
        // TIME FILTER FOR PROFIT CHART
        // ============================================
        function filterProfitChart(timeframe) {
            currentTimeframe = timeframe;
            
            // Update button states
            document.querySelectorAll('[data-timeframe]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-timeframe="${timeframe}"]`).classList.add('active');
            
            // Filter bets based on timeframe
            let filteredBets = allBets;
            
            if (timeframe !== 'all') {
                const cutoffDate = new Date();
                
                if (timeframe === 'ytd') {
                    cutoffDate.setMonth(0, 1); // January 1st of current year
                    cutoffDate.setHours(0, 0, 0, 0);
                } else if (timeframe === '12m') {
                    cutoffDate.setMonth(cutoffDate.getMonth() - 12);
                } else if (timeframe === '6m') {
                    cutoffDate.setMonth(cutoffDate.getMonth() - 6);
                } else if (timeframe === '3m') {
                    cutoffDate.setMonth(cutoffDate.getMonth() - 3);
                }
                
                filteredBets = allBets.filter(bet => new Date(bet.date) >= cutoffDate);
            }
            
            // Update only the profit chart
            updateProfitChartOnly(filteredBets);
        }
        
        function updateProfitChartOnly(bets) {
            const completedBets = bets.filter(bet => bet.result !== 'Pending');
            const sortedBets = [...completedBets].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Cumulative profit chart
            let cumulativeProfit = 0;
            const profitData = [{ date: null, profit: 0 }];
            
            sortedBets.forEach(bet => {
                if (bet.bonusBet) {
                    cumulativeProfit += bet.payout;
                } else {
                    cumulativeProfit += bet.profit;
                }
                profitData.push({
                    date: bet.date,
                    profit: cumulativeProfit
                });
            });
            
            const profitCtx = document.getElementById('profit-chart').getContext('2d');
            
            if (profitChart) profitChart.destroy();
            
            profitChart = new Chart(profitCtx, {
                type: 'line',
                data: {
                    labels: profitData.map((d, i) => i === 0 ? 'Start' : new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Cumulative Profit',
                        data: profitData.map(d => d.profit),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            ticks: {
                                callback: value => '$' + value.toFixed(0)
                            }
                        }
                    }
                }
            });
        }
        
        // ============================================
        // BANKROLL MANAGEMENT
        // ============================================
        async function loadBankroll() {
            try {
                // Fetch all transactions
                const snapshot = await db.collection('bankroll').orderBy('date', 'desc').get();
                
                const transactions = [];
                snapshot.forEach(doc => {
                    transactions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Calculate balances and totals per sportsbook
                // Normalize sportsbook names to prevent duplicates from spacing/case differences
                const normalizeSportsbook = (name) => name.trim();
                
                const sportsbookData = {};
                transactions.forEach(tx => {
                    const sportsbook = normalizeSportsbook(tx.sportsbook);
                    if (!sportsbookData[sportsbook]) {
                        sportsbookData[sportsbook] = {
                            totalDeposited: 0,
                            totalWithdrawn: 0,
                            balance: 0
                        };
                    }
                    if (tx.type === 'Deposit') {
                        sportsbookData[sportsbook].totalDeposited += tx.amount;
                    } else {
                        sportsbookData[sportsbook].totalWithdrawn += tx.amount;
                    }
                });
                
                // Calculate Current Balance and Total Profit per sportsbook
                allBets.forEach(bet => {
                    const sportsbook = normalizeSportsbook(bet.sportsbook);
                    if (!sportsbookData[sportsbook]) {
                        sportsbookData[sportsbook] = {
                            totalDeposited: 0,
                            totalWithdrawn: 0,
                            balance: 0
                        };
                    }
                    
                    // For Current Balance calculation:
                    // Current Balance = Total Deposited - Total Withdrawn - Wager in Pending - Wager in History + Payout in History
                    
                    if (bet.result === 'Pending' && !bet.bonusBet) {
                        // Subtract pending bet wagers
                        sportsbookData[sportsbook].balance -= bet.wager;
                    } else if (bet.result !== 'Pending') {
                        // For completed bets: subtract wager, add payout
                        if (!bet.bonusBet) {
                            sportsbookData[sportsbook].balance -= bet.wager;
                        }
                        sportsbookData[sportsbook].balance += bet.payout;
                    }
                });
                
                // Now calculate the actual balance for each sportsbook
                Object.keys(sportsbookData).forEach(sportsbook => {
                    const data = sportsbookData[sportsbook];
                    // Current Balance = Total Deposited - Total Withdrawn + (bet adjustments already applied above)
                    data.balance = data.totalDeposited - data.totalWithdrawn + data.balance;
                });
                
                // Calculate Total Profit per sportsbook
                // Total Profit = Total Withdrawn - Total Deposited + Current Balance
                const sportsbookProfits = {};
                Object.entries(sportsbookData).forEach(([sportsbook, data]) => {
                    sportsbookProfits[sportsbook] = data.totalWithdrawn - data.totalDeposited + data.balance;
                });
                
                // Update transactions table
                const txTbody = document.getElementById('bankroll-transactions');
                if (transactions.length === 0) {
                    txTbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No transactions yet</td></tr>';
                } else {
                    const last10Transactions = transactions.slice(0, 10);
                    txTbody.innerHTML = last10Transactions.map(tx => `
                        <tr>
                            <td>${formatDateForDisplay(tx.date)}</td>
                            <td>${tx.sportsbook}</td>
                            <td><span class="badge badge-${tx.type === 'Deposit' ? 'success' : 'warning'}">${tx.type}</span></td>
                            <td>$${tx.amount.toFixed(2)}</td>
                            <td class="admin-only">
                                <button class="btn btn-sm btn-danger" onclick="deleteBankrollTransaction('${tx.id}')">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }
                
                // Update balances table with full breakdown
                const balTbody = document.getElementById('bankroll-balances');
                
                // Sort sportsbooks alphabetically
                const sportsbookEntries = Object.entries(sportsbookData).sort((a, b) => a[0].localeCompare(b[0]));
                
                // Debug: log sportsbook names to check for duplicates
                console.log('Sportsbooks in balance table:', sportsbookEntries.map(([name]) => name));
                
                if (sportsbookEntries.length === 0) {
                    balTbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No balances yet</td></tr>';
                } else {
                    balTbody.innerHTML = sportsbookEntries.map(([sportsbook, data]) => {
                        const profit = sportsbookProfits[sportsbook] || 0;
                        // Format currency with proper negative sign
                        const formatCurrency = (amount) => amount >= 0 ? '$' + amount.toFixed(2) : '-$' + Math.abs(amount).toFixed(2);
                        return `
                            <tr>
                                <td>${sportsbook}</td>
                                <td>${formatCurrency(data.totalDeposited)}</td>
                                <td>${formatCurrency(data.totalWithdrawn)}</td>
                                <td class="${data.balance >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(data.balance)}</td>
                                <td class="${profit >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(profit)}</td>
                            </tr>
                        `;
                    }).join('');
                }
                
            } catch (error) {
                console.error('Error loading bankroll:', error);
            }
        }
        
        // Add bankroll transaction
        document.getElementById('bankroll-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAdmin) {
                alert('You must be signed in as admin to add transactions');
                return;
            }
            
            try {
                const transaction = {
                    date: document.getElementById('bankroll-date').value,
                    sportsbook: document.getElementById('bankroll-sportsbook').value,
                    type: document.getElementById('bankroll-type').value,
                    amount: parseFloat(document.getElementById('bankroll-amount').value),
                    timestamp: Date.now()  // Keep for sorting
                };
                
                await db.collection('bankroll').add(transaction);
                
                alert('Transaction added successfully!');
                document.getElementById('bankroll-form').reset();
                document.getElementById('bankroll-date').value = getLocalDateString();
                loadBankroll();
                
            } catch (error) {
                console.error('Error adding transaction:', error);
                alert('Error adding transaction: ' + error.message);
            }
        });
        
        // Delete bankroll transaction
        async function deleteBankrollTransaction(txId) {
            if (!isAdmin) {
                alert('You must be signed in as admin to delete transactions');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this transaction?')) return;
            
            try {
                await db.collection('bankroll').doc(txId).delete();
                alert('Transaction deleted successfully!');
                loadBankroll();
            } catch (error) {
                console.error('Error deleting transaction:', error);
                alert('Error deleting transaction');
            }
        }
        
        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>